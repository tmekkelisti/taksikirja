"use strict";angular.module("taksiajoApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","firebase","firebase.ref","firebase.auth","ui.bootstrap"]),angular.module("taksiajoApp").run(["$rootScope","Auth",function(a,b){a.logout=function(){b.$unauth()}}]),angular.module("taksiajoApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("firebase.config",[]).constant("FBURL","https://taksi.firebaseio.com").constant("SIMPLE_LOGIN_PROVIDERS",["password","anonymous","facebook","google"]).constant("loginRedirectPath","/login"),angular.module("firebase.ref",["firebase","firebase.config"]).factory("Ref",["$window","FBURL",function(a,b){return new a.Firebase(b)}]),angular.module("taksiajoApp").controller("ChatCtrl",["$scope","Ref","$firebaseArray","$timeout",function(a,b,c,d){function e(b){a.err=b,d(function(){a.err=null},5e3)}a.messages=c(b.child("messages").limitToLast(10)),a.messages.$loaded()["catch"](e),a.addMessage=function(b){b&&a.messages.$add({text:b})["catch"](e)}}]),angular.module("taksiajoApp").filter("reverse",function(){return function(a){return angular.isArray(a)?a.slice().reverse():[]}}),function(){angular.module("firebase.auth",["firebase","firebase.ref"]).factory("Auth",["$firebaseAuth","Ref",function(a,b){return a(b)}])}(),angular.module("taksiajoApp").controller("LoginCtrl",["$scope","Auth","$location","$q","Ref","$timeout",function(a,b,c,d,e,f){function g(a){return h(a.substr(0,a.indexOf("@"))||"")}function h(a){a+="";var b=a.charAt(0).toUpperCase();return b+a.substr(1)}function i(){c.path("/account")}function j(b){a.err=b}a.oauthLogin=function(c){a.err=null,b.$authWithOAuthPopup(c,{rememberMe:!0}).then(i,j)},a.anonymousLogin=function(){a.err=null,b.$authAnonymously({rememberMe:!0}).then(i,j)},a.passwordLogin=function(c,d){a.err=null,b.$authWithPassword({email:c,password:d},{rememberMe:!0}).then(i,j)},a.createAccount=function(c,h,k){function l(a){var b=e.child("users",a.uid),h=d.defer();return b.set({email:c,name:g(c)},function(a){f(function(){a?h.reject(a):h.resolve(b)})}),h.promise}a.err=null,h?h!==k?a.err="Salasanat eivät täsmää":b.$createUser({email:c,password:h}).then(function(){return b.$authWithPassword({email:c,password:h},{rememberMe:!0})}).then(l).then(i,j):a.err="Kirjoita salasana"}}]),angular.module("taksiajoApp").controller("AccountCtrl",["$scope","user","Auth","Ref","$firebaseObject","$timeout",function(a,b,c,d,e,f){function g(a){i(a,"danger")}function h(a){i(a,"success")}function i(b,c){var d={text:b+"",type:c};a.messages.unshift(d),f(function(){a.messages.splice(a.messages.indexOf(d),1)},1e4)}a.user=b,a.logout=function(){c.$unauth()},a.messages=[];var j=e(d.child("users/"+b.uid));j.$bindTo(a,"profile"),a.changePassword=function(d,e,f){a.err=null,console.log(b.password.email),d&&e?e!==f?g("Passwords do not match"):c.$changePassword({email:b.password.email,oldPassword:d,newPassword:e}).then(function(){h("Password changed")},g):g("Please enter all fields")},a.changeEmail=function(d,e){a.err=null,c.$changeEmail({password:d,newEmail:e,oldEmail:b.password.email}).then(function(){j.email=e,j.$save(),h("Email changed")})["catch"](g)}}]),angular.module("taksiajoApp").directive("ngShowAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("taksiajoApp").directive("ngHideAuth",["Auth","$timeout",function(a,b){return{restrict:"A",link:function(c,d){function e(){b(function(){d.toggleClass("ng-cloak",!!a.$getAuth())},0)}d.addClass("ng-cloak"),a.$onAuth(e),e()}}}]),angular.module("taksiajoApp").config(["$routeProvider","SECURED_ROUTES",function(a,b){a.whenAuthenticated=function(c,d){return d.resolve=d.resolve||{},d.resolve.user=["Auth",function(a){return a.$requireAuth()}],a.when(c,d),b[c]=!0,a}}]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/chat",{templateUrl:"views/chat.html",controller:"ChatCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).whenAuthenticated("/account",{templateUrl:"views/account.html",controller:"AccountCtrl"}).whenAuthenticated("/shift",{templateUrl:"views/shift.html",controller:"ShiftCtrl"}).otherwise({redirectTo:"/"})}]).run(["$rootScope","$location","Auth","SECURED_ROUTES","loginRedirectPath",function(a,b,c,d,e){function f(a){!a&&g(b.path())&&b.path(e)}function g(a){return d.hasOwnProperty(a)}c.$onAuth(f),a.$on("$routeChangeError",function(a,c,d,f){"AUTH_REQUIRED"===f&&b.path(e)})}]).constant("SECURED_ROUTES",{}),angular.module("taksiajoApp").controller("ShiftCtrl",["$filter","Auth","$scope","Ref","$firebaseArray","$timeout","user","$firebaseObject",function(a,b,c,d,e,f,g,h){c.isCollapsed=!0,c.user=g,c.logout=function(){b.$unauth()};var i=h(d.child("users/"+g.uid)),j=e(d.child("users/"+g.uid+"/shifts"));j.$loaded(function(a){console.log(a),angular.forEach(a,function(a){var b=new Date(a.date);a.date=b}),c.shifts=a}),j.$watch(function(){angular.forEach(j,function(a){a.date=new Date(a.date)}),c.shifts=j,c.sumMonth()}),c.selectedMonth=(new Date).getMonth();var k=["Tammikuu","Helmikuu","Maaliskuu","Huhtikuu","Toukokuu","Kesäkuu","Heinäkuu","Elokuu","Syyskuu","Lokakuu","Marraskuu","Joulukuu"];c.$watch("selectedMonth",function(){""==c.selectedMonth?c.monthName="Vuosikatsaus":c.monthName=k[c.selectedMonth],c.sumMonth()}),c.monthFilter=function(a){return c.selectedMonth?a.date.getMonth()==c.selectedMonth:!0},c.addShift=function(a,b){if(c.err=null,a&&b){var d=.9*b,e=i.provision,f=.9*b*e/100;c.shifts.$add({date:a.getTime(),earnings:b,earnings0:d,wage:f})}},c.sumMonth1="",c.sumMonth=function(){var a=0,b=0,d=0;""==c.selectedMonth?angular.forEach(j,function(c){a+=c.earnings,b+=c.earnings0,d+=c.wage}):angular.forEach(j,function(e){e.date.getMonth()==c.selectedMonth&&(a+=e.earnings,b+=e.earnings0,d+=e.wage)});var e=.057*d,f=.0065*d,g=i.tax/100*d,h=d-e-f-g;c.sumMonth1={alv:a,alv0:b,wage:d,tyel:e,tvm:f,tax:g,pay:h}},c.today=function(){c.date=new Date},c.date=c.today(),c.yesterday=function(){var a=new Date;a.setDate(a.getDate()-1),c.date=a}}]);